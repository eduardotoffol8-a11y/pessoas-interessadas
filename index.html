<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caderno de Interessados</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <meta name="theme-color" content="#0ea5e9"/>
  <style>
    :root { --accent: #06b6d4; --accent-weak: rgba(6, 182, 212, .35); }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
    .grid-bg { background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 24px 24px; }
    .ring-focus:focus { box-shadow: 0 0 0 3px var(--accent-weak); outline: none; }
    @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.6);} 70% { box-shadow: 0 0 0 12px rgba(34,197,94,0);} 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0);} }
    .due-pulse { animation: pulse-ring 1.5s infinite; }
    .accent-bg { background-color: var(--accent); }
    .accent-text { color: var(--accent); }
    .accent-border { border-color: var(--accent); }
  </style>
</head>
<body class="min-h-screen text-slate-100 bg-slate-900 grid-bg">
  <header class="sticky top-0 z-40 border-b border-white/10 bg-slate-900/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-wrap items-center gap-3">
      <div class="h-10 w-10 rounded-2xl grid place-items-center" style="background-color: color-mix(in oklab, var(--accent) 20%, transparent)">
        <i data-lucide="book-marked" class="accent-text"></i>
      </div>
      <div class="flex-1 min-w-[220px]">
        <h1 class="text-xl font-semibold tracking-tight">Caderno de Interessados</h1>
        <p class="text-xs text-slate-400">Revisitas • Estudos da Bíblia • Lembretes visuais e audíveis</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-xs hidden sm:flex items-center gap-2 bg-white/5 border border-white/10 rounded-xl px-2 py-1">
          <span class="text-slate-400">Congregação</span>
          <input id="congregacao" placeholder="Nome da congregação" class="bg-transparent outline-none ring-focus px-2 py-1"/>
        </label>
        <span id="badgeTotal" class="px-2 py-1 text-xs rounded-lg bg-white/5 border border-white/10">Total: 0</span>
        <span id="badgeOverdue" class="px-2 py-1 text-xs rounded-lg bg-rose-500/20 border border-rose-400/30 text-rose-200">Atrasados: 0</span>
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-white/10 text-xs">Exportar JSON</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-white/10 text-xs">Importar JSON</button>
        <button id="btnClear" class="px-3 py-2 rounded-xl bg-rose-600/80 hover:bg-rose-500 text-xs">Limpar Dados</button>
      </div>
    </div>
  </header>  <main class="max-w-6xl mx-auto p-4 grid lg:grid-cols-3 gap-4">
    <!-- Left column: form -->
    <section class="lg:col-span-1 glass rounded-2xl border border-white/10 p-4">
      <h2 class="text-sm font-semibold mb-3 flex items-center gap-2"><i data-lucide="user-plus" class="w-4 h-4 accent-text"></i>Novo cadastro</h2>
      <form id="form" class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Nome<input name="nome" required class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10" /></label>
          <label class="text-xs">Idade<input name="idade" type="number" min="0" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10" /></label>
        </div>
        <label class="text-xs block">Endereço / Link Maps<input name="endereco" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10" placeholder="Rua, bairro — ou cole um link do Google Maps"/></label>
        <label class="text-xs block">Contato (Whats/Telefone)<input name="contato" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Tipo
            <select name="tipo" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10">
              <option>Interessado</option>
              <option>Revisita</option>
              <option>Estudo</option>
            </select>
          </label>
          <label class="text-xs">Nível de interesse
            <select name="interesse" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10">
              <option value="1">1 • Semente</option>
              <option value="2">2 • Curioso</option>
              <option value="3" selected>3 • Receptivo</option>
              <option value="4">4 • Engajado</option>
              <option value="5">5 • Muito interessado</option>
            </select>
          </label>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs">Próxima visita
            <input name="proxima" type="datetime-local" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/>
          </label>
          <label class="text-xs">Avisar antes (min)
            <input name="lembrete" type="number" min="0" value="30" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/>
          </label>
        </div>
        <label class="text-xs block">Anotações<textarea name="notas" rows="3" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10" placeholder="Temas, necessidades, textos bíblicos…"></textarea></label>
        <div class="flex items-center justify-between">
          <label class="flex items-center gap-2 text-xs">
            <input id="soundToggle" type="checkbox" class="accent-cyan-500" checked>
            Alarme sonoro
          </label>
          <button class="accent-bg hover:opacity-90 text-slate-900 font-semibold px-4 py-2 rounded-xl" type="submit">Adicionar</button>
        </div>
      </form>
      <audio id="alarm" preload="auto"></audio>
    </section><!-- Right column: list + tools -->
<section class="lg:col-span-2 space-y-4">
  <div class="glass rounded-2xl border border-white/10 p-3 flex flex-wrap items-center gap-2">
    <div class="relative flex-1">
      <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
      <input id="search" placeholder="Buscar por nome, endereço, tema…" class="pl-9 pr-3 py-2 w-full rounded-xl bg-slate-800 border border-white/10 ring-focus"/>
    </div>
    <select id="filterTipo" class="px-3 py-2 rounded-xl bg-slate-800 border border-white/10">
      <option value="">Todos</option>
      <option>Interessado</option>
      <option>Revisita</option>
      <option>Estudo</option>
    </select>
    <select id="filterInteresse" class="px-3 py-2 rounded-xl bg-slate-800 border border-white/10">
      <option value="">Interesse (todos)</option>
      <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option>
    </select>
    <button id="btnIcsAll" class="px-3 py-2 rounded-xl bg-emerald-500/20 text-emerald-300 border border-emerald-400/30 hover:bg-emerald-500/30 text-xs">Baixar .ics (tudo)</button>
  </div>

  <div id="list" class="grid md:grid-cols-2 gap-3"></div>

  <div class="glass rounded-2xl border border-white/10 p-4">
    <h3 class="text-sm font-semibold mb-2 flex items-center gap-2"><i data-lucide="calendar-range" class="w-4 h-4 accent-text"></i> Mapa da Semana</h3>
    <div id="weekMap" class="grid md:grid-cols-7 gap-2 text-xs"></div>
  </div>

  <div class="glass rounded-2xl border border-white/10 p-4">
    <h3 class="text-sm font-semibold mb-2 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 accent-text"></i> Calendário — próximos 7 dias</h3>
    <ul id="calendar" class="divide-y divide-white/5"></ul>
  </div>

  <div class="glass rounded-2xl border border-white/10 p-4">
    <h3 class="text-sm font-semibold mb-2">Resumo</h3>
    <p id="counter" class="text-sm text-slate-300"></p>
  </div>
</section>

  </main>  <!-- Edit dialog -->  <dialog id="dlg" class="rounded-2xl backdrop:bg-black/60">
    <form id="formEdit" method="dialog" class="w-[90vw] max-w-2xl p-4 bg-slate-900 text-slate-100 rounded-2xl border border-white/10">
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-semibold text-sm">Editar cadastro</h4>
        <button type="button" onclick="dlg.close()" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
      </div>
      <div class="grid md:grid-cols-2 gap-2">
        <label class="text-xs">Nome<input name="nome" required class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs">Idade<input name="idade" type="number" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs md:col-span-2">Endereço / Link Maps<input name="endereco" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs">Contato<input name="contato" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs">Tipo<select name="tipo" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"><option>Interessado</option><option>Revisita</option><option>Estudo</option></select></label>
        <label class="text-xs">Interesse<select name="interesse" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></label>
        <label class="text-xs">Próxima visita<input name="proxima" type="datetime-local" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs">Avisar antes (min)<input name="lembrete" type="number" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"/></label>
        <label class="text-xs md:col-span-2">Anotações<textarea name="notas" rows="4" class="mt-1 ring-focus w-full px-3 py-2 rounded-xl bg-slate-800 border border-white/10"></textarea></label>
      </div>
      <div class="flex items-center justify-between mt-3">
        <button type="button" id="btnSaveEdit" class="accent-bg hover:opacity-90 text-slate-900 font-semibold px-4 py-2 rounded-xl">Salvar</button>
        <button type="button" id="btnDelete" class="bg-rose-600/90 hover:bg-rose-500 text-white px-4 py-2 rounded-xl">Excluir</button>
      </div>
    </form>
  </dialog>  <script>
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const storeKey = 'interessados.v1';
    const cfgKey = 'interessados.cfg.v1';
    let data = load();
    let cfg = loadCfg();

    const listEl = $('#list');
    const calEl = $('#calendar');
    const weekEl = $('#weekMap');
    const form = $('#form');
    const dlg = $('#dlg');
    const formEdit = $('#formEdit');
    const alarm = $('#alarm');

    function uid(){ return crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2); }
    function load(){ try { return JSON.parse(localStorage.getItem(storeKey)) || []; } catch { return []; } }
    function save(){ localStorage.setItem(storeKey, JSON.stringify(data)); updateBadges(); updateCounter(); }
    function loadCfg(){ try { return JSON.parse(localStorage.getItem(cfgKey)) || {}; } catch { return {}; } }
    function saveCfg(){ localStorage.setItem(cfgKey, JSON.stringify(cfg)); }

    // INIT CFG
    const congInput = $('#congregacao');
    function applyCfg(){
      congInput.value = cfg.congregacao || '';
      alarm.src = cfg.sound || defaultBeep();
    }

    // badges & counters
    function updateBadges(){
      $('#badgeTotal').textContent = 'Total: ' + data.length;
      const now = Date.now();
      const overdue = data.filter(p=>p.proxima && new Date(p.proxima).getTime() < now).length;
      $('#badgeOverdue').textContent = 'Atrasados: ' + overdue;
    }
    function updateCounter(){
      const revisita = data.filter(p=>p.tipo==='Revisita').length;
      const estudo = data.filter(p=>p.tipo==='Estudo').length;
      const interessado = data.filter(p=>p.tipo==='Interessado').length;
      $('#counter').textContent = `Interessados: ${interessado} • Revisitas: ${revisita} • Estudos: ${estudo}`;
    }

    function interestBadge(n){
      const map = {1:['Semente','bg-slate-700 text-slate-200'],2:['Curioso','bg-blue-700/40 text-blue-200'],3:['Receptivo','bg-emerald-600/30 text-emerald-200'],4:['Engajado','bg-amber-600/30 text-amber-200'],5:['Muito interessado','bg-pink-600/30 text-pink-200']};
      const [label, cls] = map[n]||['—','bg-slate-700'];
      return `<span class="px-2 py-0.5 text-[10px] rounded-full border border-white/10 ${cls}">${n} • ${label}</span>`;
    }

    function formatDT(dt){ if(!dt) return '—'; const d = new Date(dt); if(isNaN(+d)) return '—'; return d.toLocaleString(); }
    function digits(s){ return (s||'').toString().replace(/\D/g,''); }

    function isDueSoon(p){
      if(!p.proxima) return false; const t = new Date(p.proxima).getTime(); if(isNaN(t)) return false;
      const now = Date.now(); const lead = (p.lembrete||0)*60*1000; return now >= (t - lead) && now <= (t + 10*60*1000);
    }

    function card(p){
      const due = isDueSoon(p);
      return `<div class=\"rounded-2xl border border-white/10 glass p-3 ${due? 'due-pulse ring-2 accent-border' : ''}\">`
      + `<div class=\"flex items-start justify-between gap-2\">`
      + `<div><h4 class=\"font-semibold\">${p.nome||'Sem nome'}</h4><div class=\"text-[11px] text-slate-400\">${p.tipo||'—'} • ${p.idade? (p.idade+' anos'):'—'}</div></div>`
      + `<div class=\"flex items-center gap-2\">${interestBadge(+p.interesse||3)}<button data-act=\"edit\" data-id=\"${p.id}\" class=\"p-2 rounded-lg hover:bg-white/5\" title=\"Editar\"><i data-lucide=\"pencil\"></i></button></div>`
      + `</div>`
      + `<div class=\"mt-2 space-y-1 text-sm\">`
      + `<div class=\"flex items-center gap-2\"><i data-lucide=\"map-pin\" class=\"w-4 h-4 text-slate-400\"></i><a href=\"${p.endereco||'#'}\" target=\"_blank\" class=\"underline decoration-dotted\">${p.endereco||'—'}</a></div>`
      + `<div class=\"flex items-center gap-2\"><i data-lucide=\"phone\" class=\"w-4 h-4 text-slate-400\"></i><a href=\"https://wa.me/${digits(p.contato)}\" target=\"_blank\" class=\"underline decoration-dotted\">${p.contato||'—'}</a></div>`
      + `<div class=\"flex items-center gap-2\"><i data-lucide=\"alarm-clock\" class=\"w-4 h-4 text-slate-400\"></i><span>Próxima: <strong>${formatDT(p.proxima)}</strong> <span class=\"text-xs text-slate-400\">(aviso ${p.lembrete||0} min antes)</span></span>${p.proxima ? `<button data-act=\"ics\" data-id=\"${p.id}\" class=\"ml-auto text-xs px-2 py-1 rounded-lg bg-emerald-500/20 text-emerald-200 border border-emerald-400/30\">.ics</button>`:''}</div>`
      + `</div>`
      + `<p class=\"mt-2 text-sm text-slate-200 whitespace-pre-wrap\">${p.notas||''}</p>`
      + `</div>`;
    }

    function render(){
      const q = $('#search').value.trim().toLowerCase();
      const fTipo = $('#filterTipo').value;
      const fInt = $('#filterInteresse').value;
      let list = [...data];
      if(q){ list = list.filter(p => JSON.stringify(p).toLowerCase().includes(q)); }
      if(fTipo){ list = list.filter(p => p.tipo===fTipo); }
      if(fInt){ list = list.filter(p => String(p.interesse)===String(fInt)); }
      list.sort((a,b)=>{
        const ad = a.proxima? new Date(a.proxima).getTime() : Infinity;
        const bd = b.proxima? new Date(b.proxima).getTime() : Infinity;
        return ad - bd;
      });
      listEl.innerHTML = list.map(card).join('');
      lucide.createIcons();
      renderCalendar();
      renderWeekMap();
      updateBadges();
      updateCounter();
    }

    function renderCalendar(){
      const now = new Date();
      const next7 = new Date(now.getTime()+7*24*60*60*1000);
      const items = data.filter(p=>p.proxima).map(p=>({p, t:new Date(p.proxima)})).filter(x=>x.t>=now && x.t<=next7).sort((a,b)=>a.t-b.t);
      calEl.innerHTML = items.length? items.map(({p,t})=>`<li class=\"py-2 flex items-center gap-2\"><i data-lucide=\"clock\" class=\"w-4 h-4 text-slate-400\"></i><span class=\"text-sm\">${t.toLocaleString()} — <strong>${p.nome}</strong> <span class=\"text-slate-400\">(${p.tipo})</span></span></li>`).join('') : '<li class=\"py-2 text-sm text-slate-400\">Sem compromissos nos próximos 7 dias.</li>';
      lucide.createIcons();
    }

    function renderWeekMap(){
      const start = startOfWeek(new Date());
      const days = Array.from({length:7}, (_,i)=> new Date(start.getTime()+i*24*60*60*1000));
      const buckets = days.map(d=>({day:d, items: []}));
      data.forEach(p=>{
        if(!p.proxima) return; const t = new Date(p.proxima);
        const idx = Math.floor((stripTime(t)-stripTime(start))/86400000);
        if(idx>=0 && idx<7) buckets[idx].items.push(p);
      });
      weekEl.innerHTML = buckets.map((b)=>{
        const label = b.day.toLocaleDateString(undefined,{weekday:'short', day:'2-digit'});
        const items = b.items.sort((a,b)=> new Date(a.proxima)-new Date(b.proxima)).map(x=>`<li class=\"flex items-center gap-1\"><i data-lucide=\"dot\" class=\"w-4 h-4\"></i><span>${new Date(x.proxima).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} — ${x.nome}</span></li>`).join('');
        return `<div class=\"p-3 rounded-xl bg-white/5 border border-white/10\"><div class=\"text-[11px] text-slate-400 mb-1\">${label}</div><div class=\"text-xs mb-1\">${b.items.length} compromisso(s)</div><ul class=\"space-y-1\">${items||'<li class=\"text-slate-500\">—</li>'}</ul></div>`;
      }).join('');
      lucide.createIcons();
    }

    function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
    function startOfWeek(d){ const n = new Date(d); const day = (n.getDay()+6)%7; n.setDate(n.getDate()-day); n.setHours(0,0,0,0); return n; }

    // Add new
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const p = Object.fromEntries(fd.entries());
      const item = { id: uid(), nome:p.nome, idade:+p.idade||'', endereco:p.endereco, contato:p.contato, tipo:p.tipo, interesse:+p.interesse||3, proxima:p.proxima||'', lembrete:+p.lembrete||0, notas:p.notas||'' };
      data.push(item); save(); form.reset(); render();
    });

    // Card buttons
    listEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const p = data.find(x=>x.id===id);
      if(!p) return;
      if(act==='edit') openEdit(p);
      if(act==='ics') downloadICS([p]);
    });

    function openEdit(p){
      dlg.showModal();
      formEdit.dataset.id = p.id;
      formEdit.nome.value = p.nome||'';
      formEdit.idade.value = p.idade||'';
      formEdit.endereco.value = p.endereco||'';
      formEdit.contato.value = p.contato||'';
      formEdit.tipo.value = p.tipo||'Interessado';
      formEdit.interesse.value = p.interesse||3;
      formEdit.proxima.value = p.proxima||'';
      formEdit.lembrete.value = p.lembrete||0;
      formEdit.notas.value = p.notas||'';
    }

    $('#btnSaveEdit').addEventListener('click', ()=>{
      const id = formEdit.dataset.id; const i = data.findIndex(x=>x.id===id); if(i<0) return;
      const p = data[i];
      Object.assign(p, {
        nome: formEdit.nome.value,
        idade: formEdit.idade.value? +formEdit.idade.value : '',
        endereco: formEdit.endereco.value,
        contato: formEdit.contato.value,
        tipo: formEdit.tipo.value,
        interesse: +formEdit.interesse.value,
        proxima: formEdit.proxima.value,
        lembrete: formEdit.lembrete.value? +formEdit.lembrete.value : 0,
        notas: formEdit.notas.value,
      });
      save(); render(); dlg.close();
    });

    $('#btnDelete').addEventListener('click', ()=>{
      const id = formEdit.dataset.id; const i = data.findIndex(x=>x.id===id); if(i<0) return;
      if(confirm('Excluir este cadastro?')){
        data.splice(i,1); save(); render(); dlg.close();
      }
    });

    // Filters
    $('#search').addEventListener('input', render);
    $('#filterTipo').addEventListener('change', render);
    $('#filterInteresse').addEventListener('change', render);

    // Export / Import JSON
    $('#btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'caderno_interessados.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#btnImport').addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = ()=>{ const file = inp.files?.[0]; if(!file) return; const r = new FileReader(); r.onload = ()=>{ try{ const j = JSON.parse(r.result); if(Array.isArray(j)){ data = j; save(); render(); } }catch{ alert('Arquivo inválido.'); } }; r.readAsText(file); };
      inp.click();
    });

    // Clear all
    $('#btnClear').addEventListener('click', ()=>{
      if(confirm('Limpar TODOS os dados deste navegador?')){ localStorage.removeItem(storeKey); data = []; save(); render(); }
    });

    // Congregação save (on change)
    congInput.addEventListener('change', ()=>{ cfg.congregacao = congInput.value.trim(); saveCfg(); });

    // Lembretes
    let notified = new Set();
    function tick(){
      data.forEach(p=>{
        if(isDueSoon(p) && !notified.has(p.id)){
          notified.add(p.id);
          try { if($('#soundToggle')?.checked) { alarm.currentTime = 0; alarm.play(); } } catch(e){}
          if('Notification' in window){
            if(Notification.permission==='granted') new Notification(cfg.congregacao? `[${cfg.congregacao}] Revisita` : 'Lembrete de revisita', { body: `${p.nome} — ${p.tipo} agora/daqui a pouco` });
          }
        }
      });
      render();
    }

    if('Notification' in window && Notification.permission==='default'){
      setTimeout(()=>{ Notification.requestPermission(); }, 1000);
    }

    setInterval(tick, 30*1000);

    // ICS
    function icsEvent(p){
      const dt = p.proxima? new Date(p.proxima): null; if(!dt) return '';
      const dtStart = dt.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      const dtEnd = new Date(dt.getTime()+60*60*1000).toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      const loc = (p.endereco||'').replace(/\n/g,' ');
      const desc = (p.notas||'');
      const cong = cfg.congregacao ? ` [${cfg.congregacao}]` : '';
      return `BEGIN:VEVENT\nUID:${p.id}@caderno\nDTSTAMP:${dtStart}\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nSUMMARY:Revisita/Estudo — ${escapeIcs(p.nome)}${cong}\nLOCATION:${escapeIcs(loc)}\nDESCRIPTION:${escapeIcs(desc)}\nEND:VEVENT`;
    }
    function escapeIcs(s){ return (s||'').replace(/[\\,;]/g, (m)=>'\\'+m).replace(/\n/g,'\\n'); }

    function downloadICS(list){
      const events = list.map(icsEvent).filter(Boolean).join('\n');
      if(!events){ alert('Não há eventos com data.'); return; }
      const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Caderno Interessados//PT-BR//\n${events}\nEND:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'revisitas_estudos.ics'; a.click(); URL.revokeObjectURL(a.href);
    }

    $('#btnIcsAll').addEventListener('click', ()=> downloadICS(data.filter(d=>d.proxima)));

    // Helpers
    function defaultBeep(){ return 'data:audio/wav;base64,UklGRlYBAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YSgBAAAA/////wAAAP///wAAAP///wAAAP7+/v7+/v7+/v7+/v7+/////wAAAP///wAAAP///wAAAP///wAAAP///wAAAP7+/v7+/v7+/v7+/v7+/////w=='; }

    function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
    function startOfWeek(d){ const n = new Date(d); const day = (n.getDay()+6)%7; n.setDate(n.getDate()-day); n.setHours(0,0,0,0); return n; }

    // INIT
    (function(){
      applyCfg();
      render();
      lucide.createIcons();
    })();
  </script></body>
</html>
